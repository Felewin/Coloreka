<html><head>
<title>Coloreka!</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
<style>
  body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  
  body {
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    display: flex;
  }
  
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }

  #leftColor, #rightColor {
    flex: 1;
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  #rightColor {
    display: none;
  }

  .ripple {
    position: fixed;
    pointer-events: none;
    border-radius: 50%;
    transform: scale(0);
    opacity: 0;
    animation: rippleExpand 800ms ease-out forwards;
    z-index: 1100;
    mix-blend-mode: screen;
  }

  .colorLayer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: opacity 0.5s ease;
  }

  .wipe-transition {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: transform 0.5s ease, opacity 0.5s ease;
    backface-visibility: hidden;
  }

  @keyframes zoomIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
  }

  @keyframes rotateIn {
    from { transform: rotate(-180deg) scale(0); }
    to { transform: rotate(0) scale(1); }
  }

  #introScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, 
      #FFB3BA, #FFDFBA, #FFFFBA, #BAFFC9, #BAE1FF, #E0BBE4, #FFB3BA
    );
    background-size: 200% 100%;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    animation: moveGradient 10s linear infinite;
  }

  .baloo-2-intro-title {
    font-family: "Baloo 2", sans-serif;
    font-optical-sizing: auto;
    font-weight: 800;
    font-style: normal;
    font-size: 8vw;
    background: linear-gradient(
      to right,
      #FFB3BA, #E0BBE4, #BAE1FF, #BAFFC9, #FFFFBA, #FFDFBA, #FFB3BA
    );
    background-size: 200% auto;
    color: transparent;
    -webkit-background-clip: text;
    background-clip: text;
    opacity: 0;
    animation: rainbow 10s linear infinite;
    margin-bottom: 2vh;
  }

  .title-fade-in {
    animation: fadeIn 2s ease-in-out, rainbow 10s linear infinite;
  }

  #introRules {
    font-family: "Baloo 2", sans-serif;
    font-size: 2vw;
    color: #333;
    text-align: left;
    background-color: rgba(255, 255, 255, 0.5);
    padding: 2vh;
    border-radius: 10px;
    max-width: 80%;
    overflow-y: auto;
    max-height: 60vh;
    animation: fadeIn 2s ease-in-out;
    position: relative;
  }

  #introRules h3 {
    margin-top: 0;
  }

  #introRules ul {
    list-style-type: none;
    padding-left: 0;
  }

  #introRules li {
    margin-bottom: 1vh;
  }

  .also-plays-text {
    position: absolute;
    top: 2vh;
    right: 2vh;
    font-size: 1.2vw;
    color: #333;
    font-weight: 600;
    opacity: 0.8;
  }

  @media (orientation: portrait) {
    .baloo-2-intro-title {
      font-size: 16vw;
    }
    #introRules {
      font-size: 4vw;
    }
    .also-plays-text {
      font-size: 4.8vw;
    }
  }

  @keyframes rainbow {
    0% {
      background-position: 0% center;
    }
    100% {
      background-position: -200% center;
    }
  }

  @keyframes moveGradient {
    0% {
      background-position: 0% 50%;
    }
    100% {
      background-position: -200% 50%;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes rainbowMove {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  @keyframes rippleExpand {
    0% {
      opacity: 0;
      transform: scale(0.15);
      filter: blur(2px);
    }
    20% {
      opacity: 1;
      transform: scale(1.3);
      filter: blur(0);
    }
    100% {
      opacity: 0;
      transform: scale(9);
      filter: blur(2px);
    }
  }

  @keyframes titleJiggle {
    0% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.1) rotate(2deg); }
    50% { transform: scale(1.05) rotate(-1deg); }
    75% { transform: scale(1.08) rotate(1deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  .jiggle {
    animation: titleJiggle 300ms ease-in-out;
  }

  .rainbow-color {
    background: linear-gradient(
      to right,
      red,
      orange,
      yellow,
      green,
      blue,
      indigo,
      violet,
      red
    );
    background-size: 200% 100%;
    animation: rainbowMove 10s linear infinite;
  }
</style>
</head>
<body>
<div id="introScreen">
  <div class="baloo-2-intro-title">Coloreka!</div>
  <div id="introRules"></div>
</div>
<div id="leftColor">
  <div class="colorLayer"></div>
</div>
<div id="rightColor">
  <div class="colorLayer"></div>
</div>

<script>
const colors = ['red', 'green', 'blue', 'yellow', 'purple'];
const rippleColors = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#E964FF', '#FFA1C9'];
let currentLeftColor, currentRightColor;
let soundOn = true;
let touchStartTime = 0;
let touchCount = 0;
let longPressTimer;
let isTwoColorMode = false;
const LONG_PRESS_DURATION = 700; // milliseconds
let touchStartY = 0;
let isMobile = false;
let lastInteractionTime = 0;
const INTERACTION_COOLDOWN = 50; // 50ms cooldown between interactions
let isIntroScreen = true;
let introTapStarted = false;
let lastModeSwitchTime = 0;
const MODE_SWITCH_COOLDOWN = 300; // 300ms cooldown for mode switching
let isShiftKeyDown = false;
let colorChangesSinceIntro = 0;
let lastPointerPosition = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
let lastPointerRatio = { x: 0.5, y: 0.5 };
let rippleFollowHandle = null;
let lastSwishSound = null;
const swishSounds = ['audio/Swish (1).mp3', 'audio/Swish (2).mp3', 'audio/Swish (3).mp3', 'audio/Swish (4).mp3'];

function getRandomColor(currentLeftColor, currentRightColor) {
  let newColor;
  do {
    // Only allow rainbow after 5 changes since intro
    if (colorChangesSinceIntro > 5 && Math.random() < 0.025) {
      newColor = 'rainbow';
    } else {
      newColor = colors[Math.floor(Math.random() * colors.length)];
    }
  } while (newColor === currentLeftColor || newColor === currentRightColor);
  return newColor;
}

function changeColors() {
  if (isIntroScreen) return;

  const currentTime = new Date().getTime();
  if (currentTime - lastInteractionTime < INTERACTION_COOLDOWN) {
    return;
  }
  lastInteractionTime = currentTime;

  const previousLeftColor = currentLeftColor;
  const previousRightColor = currentRightColor;
  
  currentLeftColor = getRandomColor(currentLeftColor, currentRightColor);
  currentRightColor = getRandomColor(currentLeftColor, currentRightColor);

  colorChangesSinceIntro++; // Increment counter

  applyTransition('leftColor', currentLeftColor);
  if (isTwoColorMode) {
    applyTransition('rightColor', currentRightColor);
  }

  // Play swish sound when advancing
  playSwishSound();

  // Gentle vibration when advancing
  vibrateGentle();

  if (soundOn) {
    if (isTwoColorMode) {
      speak(`${previousLeftColor} and ${previousRightColor}`);
    } else {
      speak(previousLeftColor);
    }
  }

  requestFullscreen();
}

function applyTransition(elementId, newColor) {
  const container = document.getElementById(elementId);
  const currentLayer = container.querySelector('.colorLayer');
  const newLayer = document.createElement('div');
  
  newLayer.className = 'wipe-transition';
  if (newColor === 'rainbow') {
    newLayer.classList.add('rainbow-color');
  } else {
    newLayer.style.backgroundColor = newColor;
  }
  
  const effects = ['slide', 'zoom', 'rotate', 'curl', 'spin'];
  const effect = effects[Math.floor(Math.random() * effects.length)];
  
  switch(effect) {
    case 'slide':
      applySlideTransition(newLayer);
      break;
    case 'zoom':
      newLayer.style.transform = 'scale(0)';
      newLayer.style.opacity = '0';
      break;
    case 'rotate':
      newLayer.style.transform = 'rotate(-180deg) scale(0)';
      newLayer.style.opacity = '0';
      break;
    case 'curl':
      applyCurlTransition(newLayer);
      break;
    case 'spin':
      applySpinTransition(newLayer);
      break;
  }
  
  container.appendChild(newLayer);
  
  setTimeout(() => {
    switch(effect) {
      case 'slide':
        newLayer.style.transform = 'translate(0, 0)';
        break;
      case 'zoom':
        newLayer.style.transform = 'scale(1)';
        newLayer.style.opacity = '1';
        break;
      case 'rotate':
        newLayer.style.transform = 'rotate(0) scale(1)';
        newLayer.style.opacity = '1';
        break;
      case 'curl':
        newLayer.style.transform = 'perspective(1000px) rotateY(0deg)';
        newLayer.style.opacity = '1';
        break;
      case 'spin':
        newLayer.style.transform = 'rotate(0deg) scale(1)';
        newLayer.style.opacity = '1';
        break;
    }
  }, 50);
  
  setTimeout(() => {
    currentLayer.remove();
    newLayer.className = 'colorLayer';
    if (newColor === 'rainbow') {
      newLayer.classList.add('rainbow-color');
    }
  }, 550);
}

function applySpinTransition(newLayer) {
  newLayer.style.transformOrigin = 'center center';
  newLayer.style.transform = 'rotate(720deg) scale(0)';
  newLayer.style.opacity = '0';
}

function applyCurlTransition(newLayer) {
  newLayer.style.transformOrigin = 'bottom right';
  newLayer.style.transform = 'perspective(1000px) rotateY(-90deg)';
  newLayer.style.opacity = '0';
}

function applySlideTransition(newLayer) {
  const directions = ['Left', 'Right', 'Top', 'Bottom'];
  const direction = directions[Math.floor(Math.random() * directions.length)];
  
  switch(direction) {
    case 'Left':
      newLayer.style.transform = 'translateX(100%)';
      break;
    case 'Right':
      newLayer.style.transform = 'translateX(-100%)';
      break;
    case 'Top':
      newLayer.style.transform = 'translateY(100%)';
      break;
    case 'Bottom':
      newLayer.style.transform = 'translateY(-100%)';
      break;
  }
}

function applyFadeTransition(elementId, newColor) {
  const container = document.getElementById(elementId);
  const currentLayer = container.querySelector('.colorLayer');
  const newLayer = document.createElement('div');
  
  newLayer.className = 'colorLayer';
  if (newColor === 'rainbow') {
    newLayer.classList.add('rainbow-color');
  } else {
    newLayer.style.backgroundColor = newColor;
  }
  
  newLayer.style.opacity = '0';
  container.appendChild(newLayer);
  
  setTimeout(() => {
    newLayer.style.opacity = '1';
    currentLayer.style.opacity = '0';
  }, 50);
  
  setTimeout(() => {
    currentLayer.remove();
  }, 550);
}

function startApp() {
  if (isIntroScreen) {
    isIntroScreen = false;
    document.getElementById('introScreen').style.display = 'none';
    currentLeftColor = getRandomColor();
    currentRightColor = getRandomColor(currentLeftColor);
    applyFadeTransition('leftColor', currentLeftColor);
    requestFullscreen();

    // Play gong sound when advancing from menu
    playGongSound();
  }
}

function speak(text) {
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.volume = 0.25;
  speechSynthesis.speak(utterance);
}

function playSwishSound() {
  let availableSounds = swishSounds.filter(sound => sound !== lastSwishSound);
  const randomSound = availableSounds[Math.floor(Math.random() * availableSounds.length)];
  lastSwishSound = randomSound;

  const audio = new Audio(randomSound);
  audio.volume = 0.05; // 5% volume
  audio.play().catch(err => {
    console.log(`Error playing sound: ${err.message}`);
  });
}

function playGongSound() {
  const audio = new Audio('audio/Gong.mp3');
  audio.volume = 0.05; // 5% volume
  audio.play().catch(err => {
    console.log(`Error playing gong sound: ${err.message}`);
  });
}

function vibrateGentle() {
  if ('vibrate' in navigator) {
    navigator.vibrate(30); // Gentle 30ms vibration
  }
}

function toggleSound() {
  soundOn = !soundOn;
  speak(soundOn ? "Saying the colors" : "muted");
}

function updatePointerPosition(x, y) {
  if (typeof x !== 'number' || typeof y !== 'number' || isNaN(x) || isNaN(y)) return;
  const clampedX = Math.max(0, Math.min(window.innerWidth, x));
  const clampedY = Math.max(0, Math.min(window.innerHeight, y));
  lastPointerPosition = { x: clampedX, y: clampedY };
  lastPointerRatio = {
    x: window.innerWidth ? clampedX / window.innerWidth : 0,
    y: window.innerHeight ? clampedY / window.innerHeight : 0
  };
}

function getPointerPositionFromRatio() {
  return {
    x: window.innerWidth * lastPointerRatio.x,
    y: window.innerHeight * lastPointerRatio.y
  };
}

function positionRipplesAt(x, y) {
  document.querySelectorAll('.ripple').forEach(ripple => {
    const size = parseFloat(ripple.dataset.size) || ripple.offsetWidth || 0;
    if (!size) return;
    ripple.style.left = `${x - size / 2}px`;
    ripple.style.top = `${y - size / 2}px`;
  });
}

function jiggleTitle() {
  const title = document.querySelector('.baloo-2-intro-title');
  if (title) {
    title.classList.add('jiggle');
    setTimeout(() => title.classList.remove('jiggle'), 300);
  }
}

function followRipplesToPointer() {
  positionRipplesAt(lastPointerPosition.x, lastPointerPosition.y);
  if (document.querySelector('.ripple')) {
    rippleFollowHandle = window.requestAnimationFrame(followRipplesToPointer);
  } else {
    rippleFollowHandle = null;
  }
}

function ensureRippleFollowerRunning() {
  if (rippleFollowHandle !== null) return;
  rippleFollowHandle = window.requestAnimationFrame(followRipplesToPointer);
}

function repositionRipplesToLastPointer() {
  const { x, y } = getPointerPositionFromRatio();
  lastPointerPosition = { x, y };
  positionRipplesAt(x, y);
}

function createRipple(x, y) {
  if (typeof x !== 'number' || typeof y !== 'number') return;

  updatePointerPosition(x, y);

  const ripple = document.createElement('div');
  ripple.className = 'ripple';

  const size = 40 + Math.random() * 60;
  ripple.style.width = `${size}px`;
  ripple.style.height = `${size}px`;
  ripple.style.left = `${x - size / 2}px`;
  ripple.style.top = `${y - size / 2}px`;
  ripple.dataset.size = size;

  const color = rippleColors[Math.floor(Math.random() * rippleColors.length)];
  ripple.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
  ripple.style.boxShadow = `0 0 20px ${color}, 0 0 40px ${color}`;

  document.body.appendChild(ripple);
  ensureRippleFollowerRunning();
  setTimeout(() => ripple.remove(), 850);
}

function toggleTwoColorMode() {
  const currentTime = new Date().getTime();
  if (currentTime - lastModeSwitchTime < MODE_SWITCH_COOLDOWN) {
    return;
  }
  lastModeSwitchTime = currentTime;

  isTwoColorMode = !isTwoColorMode;
  const rightColorElement = document.getElementById('rightColor');
  if (isTwoColorMode) {
    rightColorElement.style.display = 'block';
    if (!currentRightColor || currentRightColor === currentLeftColor) {
      currentRightColor = getRandomColor(currentLeftColor, currentLeftColor);
    }
    rightColorElement.querySelector('.colorLayer').style.backgroundColor = currentRightColor;
  } else {
    rightColorElement.style.display = 'none';
  }
}

function returnToIntro() {
  isIntroScreen = true;
  colorChangesSinceIntro = 0; // Reset counter
  const introScreen = document.getElementById('introScreen');
  introScreen.style.display = 'flex';
  const title = document.querySelector('.baloo-2-intro-title');
  if (title) {
    title.style.opacity = '1';
    title.classList.remove('title-fade-in');
  }
  jiggleTitle();
  const introRules = document.getElementById('introRules');
  introRules.style.animation = 'none';
  introRules.offsetHeight; // Trigger reflow
  introRules.style.animation = null;
  document.getElementById('leftColor').innerHTML = '<div class="colorLayer"></div>';
  document.getElementById('rightColor').innerHTML = '<div class="colorLayer"></div>';
  document.getElementById('rightColor').style.display = 'none';
  isTwoColorMode = false;
  currentLeftColor = undefined;
  currentRightColor = undefined;
  if (soundOn) {
    speak("Coloreka!");
  }
}

function checkMobile() {
  isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  updateIntroRules();
}

function updateIntroRules() {
  const introRules = document.getElementById('introRules');
  introRules.innerHTML = `
    <div class="also-plays-text">${isMobile ? 'üñ•Ô∏è Also plays on desktop!' : 'ü§≥ Also plays on mobile!'}</div>
    <h3>${isMobile ? 'ü§≥ Mobile Controls!' : 'üñ•Ô∏è Desktop Controls!'}</h3>
    <ul>
      <li>‚ñ∂Ô∏è <strong>Advance</strong>! ${isMobile ? '<i>Tap</i>' : '<i>Click</i> on the screen, press <i>Enter</i>, or press <i>Spacebar</i>'}</li>
      <li>üîÑ <strong>Switch between single/two-color mode</strong>! ${isMobile ? '<i>Two-finger tap</i>' : 'Press the <i>Shift</i> key'}</li>
      <li>üîä <strong>Toggle saying the colors</strong>! ${isMobile ? '<i>Long press</i>' : "Press the <i>S</i> key"}</li>
      <li>üìú <strong>Show these instructions</strong>! ${isMobile ? '<i>Three-finger tap</i>' : 'Press <i>Escape</i>'}</li>
    </ul>
  `;
}

function requestFullscreen() {
  const element = document.documentElement;
  if (element.requestFullscreen) {
    element.requestFullscreen().catch(err => {
      console.log(`Error attempting to enable fullscreen: ${err.message}`);
    });
  } else if (element.mozRequestFullScreen) { // Firefox
    element.mozRequestFullScreen();
  } else if (element.webkitRequestFullscreen) { // Chrome, Safari and Opera
    element.webkitRequestFullscreen();
  } else if (element.msRequestFullscreen) { // IE/Edge
    element.msRequestFullscreen();
  }
}

document.body.addEventListener('mousedown', (event) => {
  if (isMobile) {
    return;
  }

  createRipple(event.clientX, event.clientY);

  if (isIntroScreen) {
    startApp();
  } else {
    changeColors();
  }
});

document.addEventListener('keydown', (event) => {
  if (!isMobile) {
    switch (event.code) {
      case 'Enter':
      case 'Space':
        if (isIntroScreen) {
          startApp();
        } else {
          changeColors();
        }
        break;
      case 'KeyS':
        toggleSound(); // Allow sound toggling on intro screen
        break;
      case 'ShiftLeft':
      case 'ShiftRight':
        if (!isIntroScreen && !isShiftKeyDown) {
          isShiftKeyDown = true;
          toggleTwoColorMode();
        }
        break;
      case 'Escape':
        if (!isIntroScreen) {
          returnToIntro();
        } else {
          jiggleTitle();
          if (soundOn) {
            speak("Coloreka!");
          }
        }
        break;
    }
  }
});

document.addEventListener('mousemove', (event) => {
  if (isMobile) {
    return;
  }
  updatePointerPosition(event.clientX, event.clientY);
});

document.addEventListener('keyup', (event) => {
  if (!isMobile) {
    switch (event.code) {
      case 'ShiftLeft':
      case 'ShiftRight':
        isShiftKeyDown = false;
        break;
    }
  }
});

document.body.addEventListener('touchstart', (event) => {
  event.preventDefault();
  Array.from(event.changedTouches || []).forEach(touch => {
    createRipple(touch.clientX, touch.clientY);
  });
  touchStartTime = new Date().getTime();
  touchCount = event.touches.length;
  isLongPress = false;
  touchStartY = event.touches[0].clientY;

  if (isIntroScreen) {
    introTapStarted = true;
    if (touchCount === 1) {
      longPressTimer = setTimeout(() => {
        if (touchCount === 1) {
          isLongPress = true;
          toggleSound();
        }
      }, LONG_PRESS_DURATION);
    }
    return;
  }

  if (touchCount === 1) {
    longPressTimer = setTimeout(() => {
      if (touchCount === 1) {
        isLongPress = true;
        toggleSound();
      }
    }, LONG_PRESS_DURATION);
  }
}, { passive: false });

document.body.addEventListener('touchend', (event) => {
  event.preventDefault();
  clearTimeout(longPressTimer);

  if (isIntroScreen) {
    if (introTapStarted && !isLongPress && touchCount === 1) {
      startApp();
    }
    introTapStarted = false;
    isLongPress = false;
    return;
  }

  if (touchCount === 2) {
    toggleTwoColorMode();
  } else if (touchCount === 1 && !isLongPress) {
    changeColors();
  } else if (touchCount === 3) {
    returnToIntro();
  }

  touchCount = 0;
}, { passive: false });

document.body.addEventListener('touchmove', (event) => {
  const touch = event.touches && event.touches[0];
  if (touch) {
    updatePointerPosition(touch.clientX, touch.clientY);
  }
}, { passive: true });

['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'].forEach(evt => {
  document.addEventListener(evt, repositionRipplesToLastPointer);
});

window.addEventListener('resize', repositionRipplesToLastPointer);

window.addEventListener('load', () => {
  checkMobile();
  const title = document.querySelector('.baloo-2-intro-title');
  if (title) {
    title.classList.add('title-fade-in');
  }
});
</script>
</body></html>